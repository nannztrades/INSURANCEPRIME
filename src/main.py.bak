
# src/main.py
from __future__ import annotations
import importlib
import importlib.util
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

def _find_router(spec_name: str, import_name: str):
    spec = importlib.util.find_spec(spec_name)
    if not spec:
        return None
    mod = importlib.import_module(import_name)
    return getattr(mod, "router", None)

# Existing dynamic routers
uploads_router = _find_router("src.api.uploads", "src.api.uploads")
agent_reports_router = _find_router("src.api.agent_reports", "src.api.agent_reports")
admin_reports_router = _find_router("src.api.admin_reports", "src.api.admin_reports")  # <-- included
ingestion_router = _find_router("src.api.ingestion_api", "src.api.ingestion_api")
ui_router = _find_router("src.api.ui_pages", "src.api.ui_pages")

# NEW: dashboards and utilities
agent_dashboard_router = _find_router("src.ui.agent_dashboard", "src.ui.agent_dashboard")
admin_dashboard_router = _find_router("src.ui.admin_dashboard", "src.ui.admin_dashboard")
superuser_dashboard_router = _find_router("src.ui.superuser_dashboard", "src.ui.superuser_dashboard")

# NEW: APIs to support UI features
disparities_router = _find_router("src.api.disparities", "src.api.disparities")
agent_missing_router = _find_router("src.api.agent_missing", "src.api.agent_missing")
uploads_secure_router = _find_router("src.api.uploads_secure", "src.api.uploads_secure")

app = FastAPI(
    title="InsuranceLocal API",
    description="Open (no-auth) API for ingesting PDFs, computing expected commissions, and generating monthly reports.",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc",
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # tighten later
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health", tags=["Health"])
def health():
    return {"status": "ok"}

@app.get("/api/info", tags=["Health"])
def api_info():
    registered = []
    if uploads_router: registered.append("Uploads")
    if uploads_secure_router: registered.append("Uploads Secure")
    if agent_reports_router: registered.append("Agent Reports")
    if admin_reports_router: registered.append("Admin Reports")  # <-- present
    if ingestion_router: registered.append("Ingestion")
    if disparities_router: registered.append("Disparities")
    if agent_missing_router: registered.append("Agent Missing")
    if ui_router: registered.append("Legacy UI")
    if agent_dashboard_router: registered.append("Agent Dashboard (UI)")
    if admin_dashboard_router: registered.append("Admin Dashboard (UI)")
    if superuser_dashboard_router: registered.append("Superuser Dashboard (UI)")
    return {
        "name": "InsuranceLocal API",
        "version": "1.0.0",
        "docs": "/docs",
        "registered_modules": registered,
        "auth": "NONE",
        "ui": {
            "agent": "/ui/agent",
            "admin": "/ui/admin",
            "superuser": "/ui/superuser"
        }
    }

# Register routers
if uploads_router:
    app.include_router(uploads_router); print("✅ Uploads router registered")
if uploads_secure_router:
    app.include_router(uploads_secure_router); print("✅ Uploads Secure router registered")
if agent_reports_router:
    app.include_router(agent_reports_router); print("✅ Agent Reports router registered")
if admin_reports_router:
    app.include_router(admin_reports_router); print("✅ Admin Reports router registered")  # <-- included
if ingestion_router:
    app.include_router(ingestion_router); print("✅ Ingestion router registered")
if disparities_router:
    app.include_router(disparities_router); print("✅ Disparities router registered")
if agent_missing_router:
    app.include_router(agent_missing_router); print("✅ Agent Missing router registered")
if ui_router:
    app.include_router(ui_router); print("✅ Legacy UI router registered")
if agent_dashboard_router:
    app.include_router(agent_dashboard_router); print("✅ Agent Dashboard (UI) registered at /ui/agent")
if admin_dashboard_router:
    app.include_router(admin_dashboard_router); print("✅ Admin Dashboard (UI) registered at /ui/admin")
if superuser_dashboard_router:
    app.include_router(superuser_dashboard_router); print("✅ Superuser Dashboard (UI) registered at /ui/superuser")
