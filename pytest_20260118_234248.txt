EEEEEEEEEEEEEEE...F.............EEEEEEEEEEEEEEEE                         [100%]
=================================== ERRORS ====================================
_______ ERROR at setup of test_admin_create_agent_rejects_without_csrf ________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
___________ ERROR at setup of test_admin_create_agent_ok_with_csrf ____________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
__________________ ERROR at setup of test_list_uploads_empty __________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_list_statements_empty _________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_________________ ERROR at setup of test_list_schedule_empty __________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_list_terminated_empty _________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_active_policies_empty _________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_________ ERROR at setup of test_agent_statements_uses_agent_context __________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_____________ ERROR at setup of test_superuser_audit_flags_empty ______________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
___________ ERROR at setup of test_agent_me_reports_agent_identity ____________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_________ ERROR at setup of test_login_agent_missing_csrf_is_rejected _________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
___________ ERROR at setup of test_login_agent_ok_with_csrf_header ____________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
______________ ERROR at setup of test_csrf_endpoint_sets_cookie _______________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_agent_login_happy_path ________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_admin_login_happy_path ________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
______________________ ERROR at setup of test_ui_landing ______________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
____________________ ERROR at setup of test_ui_login_agent ____________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
____________________ ERROR at setup of test_ui_login_admin ____________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
__________________ ERROR at setup of test_ui_login_superuser __________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
________________ ERROR at setup of test_missing_file_statement ________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_____________ ERROR at setup of test_missing_agent_code_statement _____________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
______________ ERROR at setup of test_invalid_doc_type_rejected _______________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_________ ERROR at setup of test_invalid_month_year_current_behavior __________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_____________ ERROR at setup of test_upload_statement_happy_path ______________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
______________ ERROR at setup of test_upload_schedule_happy_path ______________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_____________ ERROR at setup of test_upload_terminated_happy_path _____________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
___________ ERROR at setup of test_admin_can_upload_for_other_agent ___________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_________ ERROR at setup of test_superuser_can_upload_for_other_agent _________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
___________________ ERROR at setup of test_non_pdf_rejected ___________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
__________________ ERROR at setup of test_oversize_rejected ___________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
_____________________ ERROR at setup of test_marker_fail ______________________

    @pytest.fixture(scope="session")
    def app():
        """
        Build a FastAPI app that includes the routers under test.
        """
>       from src.api import (
            admin_reports,
            agent_api,
            superuser_api,
            uploads,
            uploads_secure,
            ingestion_api,
            agent_reports,
            agent_missing,
            disparities,
            ui_pages,
            admin_users,
            admin_agents,
            auth_api,
        )

tests\conftest.py:157: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    from __future__ import annotations
    from typing import Any, Dict, Iterable, List, Optional, Tuple
    from fastapi import APIRouter, Depends, Form, HTTPException
    from fastapi.responses import StreamingResponse
    import csv
    import io
    from src.ingestion.db import get_conn
    from src.services.roles import require_role
    from src.services.security import require_csrf
    
    router = APIRouter(
        prefix="/api/admin",
        tags=["Admin Reports"],
        dependencies=[Depends(require_role("admin", "superuser"))],
    )
    
    def _dicts_to_csv_stream(
        rows: Iterable[Dict[str, Any]],
        field_order: Optional[List[str]] = None,
        filename: Optional[str] = None,
    ) -> StreamingResponse:
        buf = io.StringIO()
        rows_list = list(rows)
        if rows_list:
            if field_order is None:
                field_order = list(rows_list[0].keys())
            writer = csv.DictWriter(buf, fieldnames=field_order, extrasaction="ignore")
            writer.writeheader()
            for r in rows_list:
                writer.writerow(r)
        buf.seek(0)
        headers = {"Content-Type": "text/csv; charset=utf-8"}
        if filename:
            headers["Content-Disposition"] = f'attachment; filename="{filename}"'
        return StreamingResponse(buf, headers=headers)
    
    def _split_holder(holder: Optional[str]) -> Tuple[str, str]:
        s = str(holder or "").strip()
        if not s:
            return "", ""
        parts = s.split()
        surname = parts[0]
        other = " ".join(parts[1:]) if len(parts) > 1 else ""
        return surname, other
    
    def _mr():
        import importlib
        return importlib.import_module("src.reports.monthly_reports")
    
    @router.get("/uploads")
    def list_uploads(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        try:
            sql = """
            SELECT `UploadID`,`agent_code`,`AgentName`,`doc_type`,`FileName`,`UploadTimestamp`,
                   `month_year`,`is_active`
            FROM `uploads` WHERE 1=1
            """
            params: List[Any] = []
            if doc_type:
                sql += " AND `doc_type`=%s"
                params.append(doc_type)
            if agent_code:
                sql += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                sql += " AND `month_year`=%s"
                params.append(month_year)
            sql += " ORDER BY `UploadID` DESC LIMIT %s OFFSET %s"
            params += [limit, offset]
            with conn.cursor() as cur:
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads.csv")
    def list_uploads_csv(
        doc_type: Optional[str] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_uploads(
            doc_type=doc_type,
            agent_code=agent_code,
            month_year=month_year,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads.csv")
    
    @router.get("/uploads/tracker")
    def uploads_tracker(agent_code: str, months_back: int = 36) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                sql = """
                SELECT m.`month_year`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='STATEMENT' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `statement` s
                                WHERE s.`agent_code`=%s AND s.`MONTH_YEAR`=m.`month_year`), 0)
                       ) AS `statement_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='SCHEDULE' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `schedule` sc
                                WHERE sc.`agent_code`=%s AND sc.`month_year`=m.`month_year`), 0)
                       ) AS `schedule_present`,
                       GREATEST(
                         IFNULL((SELECT MAX(CASE WHEN u.`doc_type`='TERMINATED' AND u.`is_active`=1 THEN 1 ELSE 0 END)
                                FROM `uploads` u
                                WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year`), 0),
                         IFNULL((SELECT MAX(1) FROM `terminated` t
                                WHERE t.`agent_code`=%s AND t.`month_year`=m.`month_year`), 0)
                       ) AS `terminated_present`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='STATEMENT') AS `statement_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='SCHEDULE') AS `schedule_upload_id`,
                       (SELECT MAX(u.`UploadID`) FROM `uploads` u
                        WHERE u.`agent_code`=%s AND u.`month_year`=m.`month_year` AND u.`doc_type`='TERMINATED') AS `terminated_upload_id`
                FROM (
                  SELECT DISTINCT u.`month_year`
                  FROM `uploads` u
                  WHERE u.`agent_code`=%s AND u.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT s.`MONTH_YEAR` AS `month_year`
                  FROM `statement` s
                  WHERE s.`agent_code`=%s AND s.`MONTH_YEAR` IS NOT NULL
                  UNION
                  SELECT DISTINCT sc.`month_year`
                  FROM `schedule` sc
                  WHERE sc.`agent_code`=%s AND sc.`month_year` IS NOT NULL
                  UNION
                  SELECT DISTINCT t.`month_year`
                  FROM `terminated` t
                  WHERE t.`agent_code`=%s AND t.`month_year` IS NOT NULL
                ) AS m
                ORDER BY STR_TO_DATE(CONCAT('01 ', m.`month_year`), '%%d %%b %%Y') DESC
                LIMIT %s
                """
                params = [
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    agent_code,
                    months_back,
                ]
                cur.execute(sql, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/uploads/tracker.csv")
    def uploads_tracker_csv(agent_code: str, months_back: int = 36) -> StreamingResponse:
        data = uploads_tracker(agent_code=agent_code, months_back=months_back)
        return _dicts_to_csv_stream(data.get("items", []), filename="uploads_tracker.csv")
    
    @router.get("/statements")
    def list_statements(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `statement_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`pay_date`,`receipt_no`,`premium`,`com_rate`,
                   `com_amt`,`inception`,`MONTH_YEAR` AS `month_year`,`AGENT_LICENSE_NUMBER`
            FROM `statement` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `MONTH_YEAR`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `statement_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/statements.csv")
    def list_statements_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_statements(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="statements.csv")
    
    def _select_schedule_latest(conn, agent_code: str, limit: int, offset: int) -> List[Dict[str, Any]]:
        with conn.cursor() as cur:
            try:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`,
                           sc.`siclase`, sc.`premium_deduction`, sc.`pensions`, sc.`welfareko`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
            except Exception:
                cur.execute(
                    """
                    SELECT sc.`month_year`, sc.`schedule_id`, sc.`upload_id`, sc.`agent_code`, sc.`agent_name`,
                           sc.`commission_batch_code`, sc.`total_premiums`, sc.`income`,
                           sc.`total_deductions`, sc.`net_commission`
                    FROM `schedule` sc
                    JOIN (
                      SELECT `month_year`, MAX(`upload_id`) AS max_upload
                      FROM `schedule` WHERE `agent_code`=%s
                      GROUP BY `month_year`
                    ) t ON sc.`month_year`=t.`month_year` AND sc.`upload_id`=t.`max_upload`
                    ORDER BY STR_TO_DATE(CONCAT('01 ', sc.`month_year`), '%%d %%b %%Y') DESC
                    LIMIT %s OFFSET %s
                    """,
                    (agent_code, limit, offset),
                )
                rows = list(cur.fetchall() or [])
                for r in rows:
                    r["siclase"] = 0.0
                    r["premium_deduction"] = 0.0
                    r["pensions"] = 0.0
                    r["welfareko"] = 0.0
            return rows
    
    @router.get("/schedule")
    def list_schedule(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        eff_latest_int = 0
        if latest_only is None and agent_code:
            eff_latest_int = 1
        elif latest_only is not None:
            val = str(latest_only).strip()
            eff_latest_int = 0 if val == "" else int(bool(int(val)))
    
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            with conn.cursor() as cur:
                if eff_latest_int and agent_code:
                    items = _select_schedule_latest(conn, agent_code, limit, offset)
                    return {"count": len(items), "items": items}
                try:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`,
                           `siclase`,`premium_deduction`,`pensions`,`welfareko`
                    FROM `schedule` WHERE 1=1
                    """
                    params: List[Any] = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                except Exception:
                    base = """
                    SELECT `month_year`,`schedule_id`,`upload_id`,`agent_code`,`agent_name`,
                           `commission_batch_code`,`total_premiums`,`income`,
                           `total_deductions`,`net_commission`
                    FROM `schedule` WHERE 1=1
                    """
                    params = []
                    if upload_id is not None:
                        base += " AND `upload_id`=%s"
                        params.append(upload_id)
                    if agent_code:
                        base += " AND `agent_code`=%s"
                        params.append(agent_code)
                    if month_year:
                        base += " AND `month_year`=%s"
                        params.append(month_year)
                    base += " ORDER BY `schedule_id` DESC LIMIT %s OFFSET %s"
                    params.extend([limit, offset])
                    cur.execute(base, tuple(params))
                    items = list(cur.fetchall() or [])
                    for r in items:
                        r["siclase"] = 0.0
                        r["premium_deduction"] = 0.0
                        r["pensions"] = 0.0
                        r["welfareko"] = 0.0
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/schedule.csv")
    def list_schedule_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        latest_only: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_schedule(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            latest_only=latest_only,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="schedule.csv")
    
    @router.get("/terminated")
    def list_terminated(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `terminated_id`,`upload_id`,`agent_code`,`policy_no`,`holder`,
                   `policy_type`,`premium`,`status`,`reason`,`month_year`,`termination_date`
            FROM `terminated` WHERE 1=1
            """
            params: List[Any] = []
            if upload_id is not None:
                base += " AND `upload_id`=%s"
                params.append(upload_id)
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `month_year`=%s"
                params.append(month_year)
            if policy_no:
                base += " AND `policy_no`=%s"
                params.append(policy_no)
            base += " ORDER BY `terminated_id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                for it in items:
                    sur, other = _split_holder(it.get("holder"))
                    it["holder_surname"] = sur
                    it["other_name"] = other
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/terminated.csv")
    def list_terminated_csv(
        upload_id: Optional[int] = None,
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        policy_no: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_terminated(
            upload_id=upload_id,
            agent_code=agent_code,
            month_year=month_year,
            policy_no=policy_no,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="terminated.csv")
    
    @router.get("/active-policies")
    def list_active_policies(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 200,
        offset: int = 0,
    ) -> Dict[str, Any]:
        conn = get_conn()
        items: List[Dict[str, Any]] = []
        try:
            base = """
            SELECT `id`,`agent_code`,`policy_no`,`policy_type`,`holder_name`,
                   `inception_date`,`first_seen_date`,`last_seen_date`,`last_seen_month_year`,
                   `last_premium`,`last_com_rate`,`status`,`consecutive_missing_months`
            FROM `active_policies` WHERE 1=1
            """
            params: List[Any] = []
            if agent_code:
                base += " AND `agent_code`=%s"
                params.append(agent_code)
            if month_year:
                base += " AND `last_seen_month_year`=%s"
                params.append(month_year)
            if status:
                base += " AND `status`=%s"
                params.append(status)
            base += " ORDER BY `id` DESC LIMIT %s OFFSET %s"
            params.extend([limit, offset])
            with conn.cursor() as cur:
                cur.execute(base, tuple(params))
                items = list(cur.fetchall() or [])
                return {"count": len(items), "items": items}
        finally:
            conn.close()
    
    @router.get("/active-policies.csv")
    def list_active_policies_csv(
        agent_code: Optional[str] = None,
        month_year: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 100000,
        offset: int = 0,
    ) -> StreamingResponse:
        data = list_active_policies(
            agent_code=agent_code,
            month_year=month_year,
            status=status,
            limit=limit,
            offset=offset,
        )
        return _dicts_to_csv_stream(data.get("items", []), filename="active_policies.csv")
    
>   @router.post("/reports/generate-agent-month", dependencies=[Depends(require_csrf())])
E   TypeError: require_csrf() missing 1 required positional argument: 'request'

src\api\admin_reports.py:502: TypeError
================================== FAILURES ===================================
_________________ test_parser_db_integration_handles_db_down __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x0000014806A958B0>

    def test_parser_db_integration_handles_db_down(monkeypatch):
        from src.ingestion import parser_db_integration as pdi
    
        # Simulate DB down: get_conn raises
        monkeypatch.setattr("src.ingestion.db.get_conn", lambda: (_ for _ in ()).throw(Exception("DB down")))
    
        rows = [
            {"policy_no": "P001", "holder": "John Doe", "MONTH_YEAR": "Jun 2025", "premium": "10.00"},
            {"policy_no": "P002", "holder": "Jane Doe", "MONTH_YEAR": "Jun 2025", "premium": "20.00"},
        ]
    
>       summary = pdi.ParserDBIntegration().process(
            doc_type_key="statement",
            agent_code="9518",
            agent_name="Agent 9518",
            df_rows=rows,
            file_path=Path("D:/PROJECT/INSURANCELOCAL/data/incoming/statement.pdf"),
            month_year_hint="Jun 2025",
        )

tests\test_parser_db_integration_unit.py:20: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\ingestion\parser_db_integration.py:109: in process
    file_hash = _sha256_of_file(file_path)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

path = WindowsPath('D:/PROJECT/INSURANCELOCAL/data/incoming/statement.pdf')

    def _sha256_of_file(path: Path) -> str:
        h = hashlib.sha256()
>       with open(path, "rb") as f:
E       FileNotFoundError: [Errno 2] No such file or directory: 'D:\\PROJECT\\INSURANCELOCAL\\data\\incoming\\statement.pdf'

src\ingestion\parser_db_integration.py:66: FileNotFoundError
=========================== short test summary info ===========================
ERROR tests/test_admin_agents_csrf.py::test_admin_create_agent_rejects_without_csrf
ERROR tests/test_admin_agents_csrf.py::test_admin_create_agent_ok_with_csrf
ERROR tests/test_admin_reports_smoke.py::test_list_uploads_empty - TypeError:...
ERROR tests/test_admin_reports_smoke.py::test_list_statements_empty - TypeErr...
ERROR tests/test_admin_reports_smoke.py::test_list_schedule_empty - TypeError...
ERROR tests/test_admin_reports_smoke.py::test_list_terminated_empty - TypeErr...
ERROR tests/test_admin_reports_smoke.py::test_active_policies_empty - TypeErr...
ERROR tests/test_agent_and_superuser_endpoints.py::test_agent_statements_uses_agent_context
ERROR tests/test_agent_and_superuser_endpoints.py::test_superuser_audit_flags_empty
ERROR tests/test_agent_me.py::test_agent_me_reports_agent_identity - TypeErro...
ERROR tests/test_auth_csrf_requirements.py::test_login_agent_missing_csrf_is_rejected
ERROR tests/test_auth_csrf_requirements.py::test_login_agent_ok_with_csrf_header
ERROR tests/test_auth_flow.py::test_csrf_endpoint_sets_cookie - TypeError: re...
ERROR tests/test_auth_flow.py::test_agent_login_happy_path - TypeError: requi...
ERROR tests/test_auth_flow.py::test_admin_login_happy_path - TypeError: requi...
ERROR tests/test_smoke_endpoints.py::test_ui_landing - TypeError: require_csr...
ERROR tests/test_smoke_endpoints.py::test_ui_login_agent - TypeError: require...
ERROR tests/test_smoke_endpoints.py::test_ui_login_admin - TypeError: require...
ERROR tests/test_smoke_endpoints.py::test_ui_login_superuser - TypeError: req...
ERROR tests/test_uploads_api_negative.py::test_missing_file_statement - TypeE...
ERROR tests/test_uploads_api_negative.py::test_missing_agent_code_statement
ERROR tests/test_uploads_api_negative.py::test_invalid_doc_type_rejected - Ty...
ERROR tests/test_uploads_api_negative.py::test_invalid_month_year_current_behavior
ERROR tests/test_uploads_api_unit.py::test_upload_statement_happy_path - Type...
ERROR tests/test_uploads_api_unit_schedule.py::test_upload_schedule_happy_path
ERROR tests/test_uploads_api_unit_terminated.py::test_upload_terminated_happy_path
ERROR tests/test_uploads_secure_roles.py::test_admin_can_upload_for_other_agent
ERROR tests/test_uploads_secure_roles.py::test_superuser_can_upload_for_other_agent
ERROR tests/test_uploads_secure_unit.py::test_non_pdf_rejected - TypeError: r...
ERROR tests/test_uploads_secure_unit.py::test_oversize_rejected - TypeError: ...
ERROR tests/test_uploads_secure_unit.py::test_marker_fail - TypeError: requir...
FAILED tests/test_parser_db_integration_unit.py::test_parser_db_integration_handles_db_down
1 failed, 16 passed, 31 errors in 5.60s
